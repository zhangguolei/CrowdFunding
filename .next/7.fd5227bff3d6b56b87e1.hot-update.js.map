{"version":3,"file":"7.fd5227bff3d6b56b87e1.hot-update.js","sources":["webpack:///components/Header.js","webpack:///pages/projects/detail.js","webpack:///routes.js"],"sourcesContent":["import React from 'react';\nimport { AppBar, Toolbar, Typography, Button } from '@material-ui/core';\nimport { withStyles } from '@material-ui/core/styles';\nimport {Link} from '../routes';\n\nconst styles = {\n  wrapper: {\n    margin: '0 auto',\n    width: '80%',\n    maxWidth: '1200px',\n    display: 'flex',\n  },\n  brand: {\n    borderRight: '2px solid #CCCCCC',\n    paddingRight: '1em',\n    marginRight: '1em',\n  },\n  toolbar: {\n    padding: 0,\n    flex: 1,\n  },\n  flexContainer: {\n    flex: 1,\n  },\n  anchor: {\n    textDecoration: 'none',\n  },\n};\n\nclass Header extends React.Component {\n  render() {\n    const { classes } = this.props;\n\n    return (\n      <AppBar position=\"static\" color=\"default\">\n        <div className={classes.wrapper}>\n          <Toolbar className={classes.toolbar}>\n            <Typography variant=\"title\" color=\"inherit\" className={classes.brand}>\n              众筹 DApp\n            </Typography>\n            <p className={classes.flexContainer}>\n              <a href=\"/\" className={classes.anchor}>\n                <Typography variant=\"title\" color=\"inherit\">\n                  项目列表\n                </Typography>\n              </a>\n            </p>\n            {/* <Button variant=\"raised\" color=\"primary\">\n              发起项目\n            </Button> */}\n            <Link route=\"/projects/create\">\n              <Button variant=\"raised\" color=\"primary\">\n                发起项目\n              </Button>\n            </Link>\n          </Toolbar>\n        </div>\n      </AppBar>\n    );\n  }\n}\n\nexport default withStyles(styles)(Header);\n\n\n// WEBPACK FOOTER //\n// components/Header.js","import React from 'react';\nimport {\n  Grid,\n  Button,\n  Typography,\n  LinearProgress,\n  CircularProgress,\n  Paper,\n  TextField,\n  Table,\n  TableHead,\n  TableBody,\n  TableRow,\n  TableCell,\n} from '@material-ui/core';\n\nimport { Link } from '../../routes';\nimport web3 from '../../libs/web3';\nimport Web3 from 'web3';\nimport Project from '../../libs/project';\nimport ProjectList from '../../libs/projectList';\nimport withRoot from '../../libs/withRoot';\nimport Layout from '../../components/Layout';\nimport InfoBlock from '../../components/InfoBlock';\n\n\n\nclass ProjectDetail extends React.Component {\n  static async getInitialProps({ query }) {\n    const contract = Project(query.address);\n\n    const summary = await contract.methods.getSummary().call();\n    const [description, minInvest, maxInvest, goal, balance, investorCount, paymentCount, owner] = Object.values(\n      summary\n    );\n\n    const tasks = [];\n    for (let i = 0; i < paymentCount; i++) {\n      tasks.push(contract.methods.payments(i).call());\n    }\n    const payments = await Promise.all(tasks);\n\n    const project = {\n      address: query.address,\n      description,\n      minInvest,\n      maxInvest,\n      goal,\n      balance,\n      investorCount,\n      paymentCount,\n      owner,\n      payments,\n    };\n\n    console.log(project);\n\n    return { project };\n  }\n\n  constructor(props) {\n    super(props);\n\n    this.state = {\n      amount: 0,\n      errmsg: '',\n      loading: false,\n      isApproving: false,\n      isPaying: false,\n    };\n\n    this.onSubmit = this.contributeProject.bind(this);\n  }\n\n  getInputHandler(key) {\n    return e => {\n      console.log(e.target.value);\n      this.setState({ [key]: e.target.value });\n    };\n  }\n\n  async contributeProject() {\n    const { amount } = this.state;\n    const { minInvest, maxInvest } = this.props.project;\n    const minInvestInEther = web3.utils.fromWei(minInvest, 'ether');\n    const maxInvestInEther = web3.utils.fromWei(maxInvest, 'ether');\n\n    console.log({ amount, minInvestInEther, maxInvestInEther });\n\n    // 字段合规检查\n    if (amount <= 0) {\n      return this.setState({ errmsg: '投资金额必须大于0' });\n    }\n    if (amount < minInvestInEther) {\n      return this.setState({ errmsg: '投资金额必须大于最小投资金额' });\n    }\n    if (amount > maxInvestInEther) {\n      return this.setState({ errmsg: '投资金额必须小于最大投资金额' });\n    }\n\n    try {\n    \n      // 获取账户\n      const accounts = await web3.eth.getAccounts();\n      const owner = accounts[0];\n    //   const owner = \"0xfa90707b4aA3D578Aa09A73Bf12252D8E518C0Ac\";\n      window.alert(this.props.project.address);\n      console.log('Owner', owner)\n      this.setState({ loading: true, errmsg: '' });\n      // 发起转账，这是合约的地址\n      const contract = Project(this.props.project.address);\n      const result = await contract.methods\n        .contribute()\n        .send({ from: owner, value: web3.utils.toWei(amount, 'ether'), gas: '5000000' });\n\n      this.setState({ errmsg: '投资成功', amount: 0 });\n      console.log(result);\n\n      setTimeout(() => {\n        location.reload();\n      }, 1000);\n    } catch (err) {\n      console.error(err);\n      this.setState({ errmsg: err.message || err.toString });\n    } finally {\n      this.setState({ loading: false });\n    }\n  }\n\n  async approvePayment(i) {\n    try {\n      this.setState({ isApproving: i });\n\n      const accounts = await web3.eth.getAccounts();\n      const sender = accounts[0];\n\n      const contract = Project(this.props.project.address);\n      const isInvestor = await contract.methods.investors(sender).call();\n      if (!isInvestor) {\n        return window.alert('只有投资人才有权投票');\n      }\n\n      const result = await contract.methods.approvePayment(i).send({ from: sender, gas: '5000000' });\n\n      window.alert('投票成功');\n\n      setTimeout(() => {\n        location.reload();\n      }, 1000);\n    } catch (err) {\n      console.error(err);\n      window.alert(err.message || err.toString());\n    } finally {\n      this.setState({ isApproving: false });\n    }\n  }\n\n  async doPayment(i) {\n    try {\n      this.setState({ isPaying: i });\n\n      const accounts = await web3.eth.getAccounts();\n      const sender = accounts[0];\n\n      // 检查账户\n      if (sender !== this.props.project.owner) {\n        return window.alert('只有管理员能创建资金支出请求');\n      }\n\n      const contract = Project(this.props.project.address);\n      const result = await contract.methods.doPayment(i).send({ from: sender, gas: '5000000' });\n\n      window.alert('资金划转成功');\n\n      setTimeout(() => {\n        location.reload();\n      }, 1000);\n    } catch (err) {\n      console.error(err);\n      window.alert(err.message || err.toString());\n    } finally {\n      this.setState({ isPaying: false });\n    }\n  }\n\n  render() {\n    const { project } = this.props;\n\n    return (\n      <Layout>\n        <Typography variant=\"title\" color=\"inherit\" style={{ margin: '15px 0' }}>\n          项目详情\n        </Typography>\n        {this.renderBasicInfo(project)}\n        <Typography variant=\"title\" color=\"inherit\" style={{ margin: '30px 0 15px' }}>\n          资金支出请求\n        </Typography>\n        {this.renderPayments(project)}\n      </Layout>\n    );\n  }\n\n  renderBasicInfo(project) {\n    const progress = project.balance / project.goal * 100;\n\n    return (\n      <Paper style={{ padding: '15px' }}>\n        <Typography gutterBottom variant=\"headline\" component=\"h2\">\n          {project.description}\n        </Typography>\n        <LinearProgress style={{ margin: '10px 0' }} color=\"primary\" variant=\"determinate\" value={progress} />\n        <Grid container spacing={16}>\n          <InfoBlock title={`${web3.utils.fromWei(project.goal, 'ether')} ETH`} description=\"募资上限\" />\n          <InfoBlock title={`${web3.utils.fromWei(project.minInvest, 'ether')} ETH`} description=\"最小投资金额\" />\n          <InfoBlock title={`${web3.utils.fromWei(project.maxInvest, 'ether')} ETH`} description=\"最大投资金额\" />\n          <InfoBlock title={`${project.investorCount}人`} description=\"参投人数\" />\n          <InfoBlock title={`${web3.utils.fromWei(project.balance, 'ether')} ETH`} description=\"已募资金额\" />\n        </Grid>\n        <Grid container spacing={16}>\n          <Grid item md={12}>\n            <TextField\n              required\n              id=\"amount\"\n              label=\"投资金额\"\n              style={{ marginRight: '15px' }}\n              value={this.state.amount}\n              onChange={this.getInputHandler('amount')}\n              margin=\"normal\"\n              InputProps={{ endAdornment: 'ETH' }}\n            />\n            <Button size=\"small\" variant=\"raised\" color=\"primary\" onClick={this.onSubmit}>\n              {this.state.loading ? <CircularProgress color=\"secondary\" size={24} /> : '立即投资'}\n            </Button>\n            {!!this.state.errmsg && (\n              <Typography component=\"p\" style={{ color: 'red' }}>\n                {this.state.errmsg}\n              </Typography>\n            )}\n          </Grid>\n        </Grid>\n      </Paper>\n    );\n  }\n\n  renderPayments(project) {\n    if (project.payments.length === 0) {\n      return (\n        <Paper style={{ padding: '15px' }}>\n          <p>还没有数据</p>\n          <Link route={`/projects/${project.address}/payments/create`}>\n            <Button variant=\"raised\" color=\"primary\">\n              创建资金支出请求\n            </Button>\n          </Link>\n        </Paper>\n      )\n    }\n\n    return (\n      <Paper style={{ padding: '15px' }}>\n        <Table style={{ marginBottom: '30px' }}>\n          <TableHead>\n            <TableRow>\n              <TableCell>支出理由</TableCell>\n              <TableCell numeric>支出金额</TableCell>\n              <TableCell>收款人</TableCell>\n              <TableCell>已完成？</TableCell>\n              <TableCell>投票状态</TableCell>\n              <TableCell>操作</TableCell>\n            </TableRow>\n          </TableHead>\n          <TableBody>\n            {project.payments.map((payment, index) => this.renderPaymentRow(payment, index, project))}\n          </TableBody>\n        </Table>\n        <Link route={`/projects/${project.address}/payments/create`}>\n          <Button variant=\"raised\" color=\"primary\">\n            创建资金支出请求\n          </Button>\n        </Link>\n      </Paper>\n    );\n  }\n\n  isApproving(i) {\n    return typeof this.state.isApproving === 'number' && this.state.isApproving === i;\n  }\n\n  isPaying(i) {\n    return typeof this.state.isPaying === 'number' && this.state.isPaying === i;\n  }\n\n  renderPaymentRow(payment, index, project) {\n    const canApprove = !payment.completed;\n    const canDoPayment = !payment.completed && payment.voterCount / project.investorCount > 0.5;\n    return (\n      <TableRow key={index}>\n        <TableCell>{payment.description}</TableCell>\n        <TableCell numeric>{web3.utils.fromWei(payment.amount, 'ether')} ETH</TableCell>\n        <TableCell>{payment.receiver}</TableCell>\n        <TableCell>{payment.completed ? '是' : '否'}</TableCell>\n        <TableCell>\n          {payment.voterCount}/{project.investorCount}\n        </TableCell>\n        <TableCell>\n          {canApprove && (\n            <Button size=\"small\" color=\"primary\" onClick={() => this.approvePayment(index)}>\n              {this.isApproving(index) ? <CircularProgress color=\"secondary\" size={24} /> : '投赞成票'}\n            </Button>\n          )}\n          {canDoPayment && (\n            <Button size=\"small\" color=\"primary\" onClick={() => this.doPayment(index)}>\n              {this.isPaying(index) ? <CircularProgress color=\"primary\" size={24} /> : '资金划转'}\n            </Button>\n          )}\n        </TableCell>\n      </TableRow>\n    );\n  }\n}\n\nexport default withRoot(ProjectDetail);\n\n\n// WEBPACK FOOTER //\n// pages/projects/detail.js","const routes = require('next-routes')();\n\nroutes\n    .add('/', '/index')\n    .add('/projects/create', 'projects/create')\n    .add('/projects/:address', 'projects/detail')\n    .add('/projects/:address/payments/create', 'projects/payments/create');\n\nmodule.exports = routes;\n\n\n// WEBPACK FOOTER //\n// routes.js"],"mappings":"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;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAQA;;;AAEA;AAAA;AACA;AAAA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAMA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAGA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAGA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAMA;;;AAEA;AACA;AACA;;;AAEA;AACA;AACA;;;AAEA;AAAA;AACA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAGA;AAAA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAIA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAMA;;;;AAnSA;AACA;AAqSA;;;;;;;;;;;;;;;;;;;;;;;;;;ACjUA;AACA;AACA;AAMA;;;;A","sourceRoot":""}